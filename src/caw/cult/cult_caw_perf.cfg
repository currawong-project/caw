{
  base_dir:    "/home/kevin/src/caw/src/caw/cult/io",
  io_dict:     "/home/kevin/src/caw/src/caw/cult/io.cfg"            // Runtime configuration file.
  proc_dict:   "/home/kevin/src/caw/src/libcw/flow/proc_dict.cfg", // Processor class definition file.
  udp_dict:    "/home/kevin/src/caw/src/libcw/flow/udp_dict.cfg",  // User defined proc files
  tracer: {  trace_cnt:1024, msg_cnt: 1024000, enable_fl:false, activate_fl:false, out_fname:"tracer" }
    
  programs: {



    ex_22_rt_audio: {
    
      network: {
        procs: {

          // Input from Spirio fallback
	  m_in: { class:midi_in, args: { print_fl:false, dev_label:"Scarlett 18i20 USB", port_label:"Scarlett 18i20 USB MIDI 1" } },
	  play_now_in: { class:midi_select, in:{ in:m_in.out } args:{ sel_status:176, sel_byte_a:127 }  }

	  // Input from pianos	  
	  m_in_a: { class:midi_in,  args:{ print_fl:false, dev_label:"MIDIFACE 2x2", port_label:"MIDIFACE 2x2 Midi Out 1"} },
	  m_in_b: { class:midi_in,  args:{ print_fl:false, dev_label:"UM-ONE", port_label:"UM-ONE MIDI 1"} },

	  spirio_seg_menu : { class: label_value_list,
	                                    args:{ out_type:uint,
					           cfg_fname:"~/src/currawong/projects/create_cult_event_score/spirio_seg_menu.json" },
	                                     ui: { create_fl:false } },
					     
	  spirio_mp : { class: multi_player,  in: { start_seg_id:spirio_seg_menu.out },
	                                    args: { cfg_fname:"~/src/currawong/projects/create_cult_event_score/spirio_mult_play.json" }
				              ui: { create_fl:false } },

	  spirio_rt: { class:recd_route, in:{ in:spirio_mp.out }, args:{ out_cnt:2, sel_field:"port_id" }  },

	  extract_midi_a: { class:recd_extract, in:{ in:spirio_rt.out0 }, args:{ out_fmt:{ alloc_cnt:1024, fields:{ midi:{type:m3, doc:"MIDI msg"} } } } }
	  extract_midi_b: { class:recd_extract, in:{ in:spirio_rt.out1 }, args:{ out_fmt:{ alloc_cnt:1024, fields:{ midi:{type:m3, doc:"MIDI msg"} } } } }

	  // Merge live MIDI with Spirio player messages
	  sf_a_merge: { class:recd_merge, in:{ in0:m_in_a.r_out, in1:extract_midi_a.out } },
	  sf_b_merge: { class:recd_merge, in:{ in0:m_in_b.r_out, in1:extract_midi_b.out } },	   

	  
	  sf_a: { class:score_follower_2, in: { in:sf_a_merge.out },
	                                args: { score_fname:"~/src/currawong/projects/create_cult_event_score/score_cult_evt_20250929_5.csv"},
				          ui: { create_fl:false } },

	  sf_b: { class:score_follower_2, in: { in:sf_b_merge.out },
	                                args: { score_fname:"~/src/currawong/projects/create_cult_event_score/score_cult_evt_20250929_5.csv"},
				          ui: { create_fl:false } },

	  sf: { class:recd_merge, in:{ in0:sf_a.out0, in1:sf_b.out0 } },

          // Set the starting 'spirio' segment
	  all_seg_menu : { class: label_value_list, args:{ out_type:uint,
					                   cfg_fname:"~/src/currawong/projects/create_cult_event_score/all_seg_menu.json" },
	                                              ui: { create_fl:true } },

	  ctl: { class:gutim_pgm_ctl, in:{ sf_loc:sf.out, goto_seg:all_seg_menu.out, play_now:play_now_in.byte_b }
	                              out:{				            
				            sf_a_beg_loc:sf_a.b_loc, sf_a_end_loc:sf_a.e_loc, sf_a_reset_fl:sf_a.reset_trigger, sf_a_enable_fl:sf_a.enable_fl,
				            sf_b_beg_loc:sf_b.b_loc, sf_b_end_loc:sf_b.e_loc, sf_b_reset_fl:sf_b.reset_trigger, sf_b_enable_fl:sf_b.enable_fl,
					    
					    // sim_play_id:simul_mp.play_id,  sim_reset_fl:simul_mp.reset,   sim_clear_fl:simul_mp.clear,
					    // spr_play_id:spirio_mp.play_id,
					    spr_reset_fl:spirio_mp.reset,  spr_play_now:spirio_mp.play_excl_id,					    
					    },
				      args:{ cfg_fname:"~/src/currawong/projects/create_cult_event_score/gutim_pgm_ctl.json"},
				      ui: { create_fl:true }}


          // Defer starting the spirio segment by waiting for particular key/pedal releases
	  spirio_ctl: { class:gutim_spirio_ctl, in: { seg_id_in:ctl.spr_play_id,
	                                              reset:ctl.reset,
	                                              midi_in_a:m_in_a.r_out,
						      midi_in_b:m_in_b.r_out },						      
					        out: { seg_id_out:spirio_mp.play_id },						
	                                        args: { cfg_fname:"/home/kevin/src/currawong/projects/create_cult_event_score/gutim_spirio_ctl.json" }
						ui:   { create_fl:false } }


	 m_record: { class:midi_recorder, in:{ rin:sf.out, write_fl:ctl.reset }, args:{ dir:"~/temp/currawong/cult/mr_video/", fname:"record", alloc_cnt:102400 }}

         // spirio-multi-player to Spirio MIDI	- these message will be correctly velocity mapped even though they have not been score followed.
	 pian_vt_a:{ class: vel_table, in:{ in:extract_midi_a.out }, args:{ vel_tbl_fname:"$/vel_table_perf.json", vel_tbl_label:"spirio_1" }},
	 pian_vt_b:{ class: vel_table, in:{ in:extract_midi_b.out }, args:{ vel_tbl_fname:"$/vel_table_perf.json", vel_tbl_label:"spirio_1" }},
	 spirio_mout_a:   { class: midi_out,  in:{ rin:pian_vt_a.out }, args:{ print_fl:false, dev_label:"MIDIFACE 2x2", port_label:"MIDIFACE 2x2 Midi Out 1" } ui: { create_fl:false }} 
	 spirio_mout_b:   { class: midi_out,  in:{ rin:pian_vt_b.out }, args:{ print_fl:false, dev_label:"UM-ONE",  port_label:"UM-ONE MIDI 1" } ui: { create_fl:false }} 

         // messages coming from sf.out will have 'score_vel' fields assigned to them if they were located in the score
	 samp_vt:{ class: vel_table, in:{ in:sf.out }, args:{ vel_tbl_fname:"$/vel_table_perf.json", vel_tbl_label:"ivory" }},

         vctl:   { class: poly_voice_ctl,             in:{ in:samp_vt.out , reset:ctl.reset},  args:{ voice_cnt:40, prune_thresh:20 } },

	 ps:     { class: gutim_ps, preset:init,         in:{ in:sf.out, midi_in_:vctl.out_, reset:ctl.reset, loc_cnt:sf_a.loc_cnt   },
	                                             preset: "init",
	                                               args:{ fname:"~/src/currawong/projects/create_cult_event_score/cult_evt_xforms_mod.txt" },
						          ui:  { create_fl:true } },

	  xform_igain:  { class: number,   args:{ in:1.0f },  ui: { create_fl:true } },

	  voice_poly: {
	    class: poly,
	    in:   { count:vctl.voice_cnt },		  
	    args: { parallel_fl:false, thread_cnt:8, cpu_affinityL:[2,3,4,6,8,9,10,11] },

	    network: {
	      procs: {
	        voc: { class:piano_voice, in:{ _.in:_.vctl.out_ },
		                          out:{ _.done_fl:_.vctl.done_fl_ },
					  args:{ wtb_fname:"~/media/audio/wt6/wt_bank.json",
					         wtb_instr:"piano",
						 rls_coeff: 0.99 } },
						 
		g:     { class: audio_gain,       in:{ in:voc.out, gain:_.xform_igain.out }  },
	        pva:   { class: pv_analysis,      in:{ in:g.out, enable:voc.gate_fl, _.wndSmpN:_.ps.wnd_smp_cnt_ },  args:{ wndSmpN:512, hopSmpN:128, hzFl:false  } },
	        sd:    { class: spec_dist,        in:{ in:pva.out,
		                                       enable:voc.gate_fl,
		                                       _.ceiling:_.ps.ceiling_,
						       _.expo:_.ps.expo_,
						       _.thresh:_.ps.thresh_,
						       _.upr:_.ps.upr_,
						       _.lwr:_.ps.lwr_,
						       _.mix:_.ps.mix_ },  preset:kc, args:{ bypass:false }   },
		
                pvs:   { class: pv_synthesis,     in:{ in:sd.out, enable:voc.gate_fl  } },
	        cmp:   { class: compressor,       in:{ in:pvs.out,
		                                       enable:voc.gate_fl,
		                                       _.igain:_.ps.c_igain_,
						       _.ogain:_.ps.c_ogain_ }, preset:kc, args:{ bypass:false }   },
						       
		ogain: { class: audio_gain,       in:{ in:cmp.out, _.gain:_.ps.dry_gain_ } },
	      }

	    }
	  }


	  wet_poly_mix: { class: audio_mix,   in:{ in_:voice_poly.ogain_.out } args:{ igain_:1.0 }},
	  dry_poly_mix: { class: audio_mix,   in:{ in_:voice_poly.voc_.out}    args:{ igain_:1.0 }},


	  // apply the wet/dry gain balance
	  wd_bal:       { class: balance, args{}},
	  wet_bal_gain: { class: audio_gain, in:{ in:wet_poly_mix.out, gain:wd_bal.out }     },
	  dry_bal_gain: { class: audio_gain, in:{ in:dry_poly_mix.out, gain:wd_bal.inv_out } },

	  mstr_wet_out: { class: audio_gain, in:{ in:wet_bal_gain.out }, args:{ gain:0.5 } }
	  mstr_dry_out: { class: audio_gain, in:{ in:dry_bal_gain.out }, args:{ gain:0.5 } },
	   

	  // merge the wet/dry signals into a single 4 channel signal
	  merge: { class: audio_merge,   in:{ in0:mstr_wet_out.out, in1:mstr_dry_out.out }  },
	  
          aout:  { class: audio_out,     in:{ in:merge.out }, args:{ dev_label:"main" } },

				  
        }
      }
    } // ex_22_rt_audio

    ex_23_rt_audio: {
    
      network: {
        procs: {

          // Input from Spirio fallback
	  m_in: { class:midi_in, args: { print_fl:false, dev_label:"Scarlett 18i20 USB", port_label:"Scarlett 18i20 USB MIDI 1" } },
	  play_now_in: { class:midi_select, in:{ in:m_in.out } args:{ sel_status:176, sel_byte_a:127 }  }

	  // Input from pianos	  
	  m_in_a: { class:midi_in,  args:{ print_fl:false, dev_label:"MIDIFACE 2x2", port_label:"MIDIFACE 2x2 Midi Out 1"} },
	  m_in_b: { class:midi_in,  args:{ print_fl:false, dev_label:"UM-ONE", port_label:"UM-ONE MIDI 1"} },

	  spirio_seg_menu : { class: label_value_list,
	                                    args:{ out_type:uint,
					           cfg_fname:"~/src/currawong/projects/create_cult_event_score/spirio_seg_menu.json" },
	                                     ui: { create_fl:false } },
					     
	  spirio_mp : { class: multi_player,  in: { start_seg_id:spirio_seg_menu.out },
	                                    args: { cfg_fname:"~/src/currawong/projects/create_cult_event_score/spirio_mult_play.json" }
				              ui: { create_fl:false } },

	  spirio_rt: { class:recd_route, in:{ in:spirio_mp.out }, args:{ out_cnt:2, sel_field:"port_id" }  },

	  extract_midi_a: { class:recd_extract, in:{ in:spirio_rt.out0 }, args:{ out_fmt:{ alloc_cnt:1024, fields:{ midi:{type:m3, doc:"MIDI msg"} } } } }
	  extract_midi_b: { class:recd_extract, in:{ in:spirio_rt.out1 }, args:{ out_fmt:{ alloc_cnt:1024, fields:{ midi:{type:m3, doc:"MIDI msg"} } } } }

	  // Merge live MIDI with Spirio player messages
	  sf_a_merge: { class:recd_merge, in:{ in0:m_in_a.r_out, in1:extract_midi_a.out } },
	  sf_b_merge: { class:recd_merge, in:{ in0:m_in_b.r_out, in1:extract_midi_b.out } },	   

	  
	  sf_a: { class:score_follower_2, in: { in:sf_a_merge.out },
	                                args: { score_fname:"~/src/currawong/projects/create_cult_event_score/score_cult_evt_20250929_5.csv"},
				          ui: { create_fl:false } },

	  sf_b: { class:score_follower_2, in: { in:sf_b_merge.out },
	                                args: { score_fname:"~/src/currawong/projects/create_cult_event_score/score_cult_evt_20250929_5.csv"},
				          ui: { create_fl:false } },

	  sf: { class:recd_merge, in:{ in0:sf_a.out0, in1:sf_b.out0 } },

          // Set the starting 'spirio' segment
	  all_seg_menu : { class: label_value_list, args:{ out_type:uint,
					                   cfg_fname:"~/src/currawong/projects/create_cult_event_score/all_seg_menu.json" },
	                                              ui: { create_fl:true } },

	  ctl: { class:gutim_pgm_ctl, in:{ sf_loc:sf.out, goto_seg:all_seg_menu.out, play_now:play_now_in.byte_b }
	                              out:{				            
				            sf_a_beg_loc:sf_a.b_loc, sf_a_end_loc:sf_a.e_loc, sf_a_reset_fl:sf_a.reset_trigger, sf_a_enable_fl:sf_a.enable_fl,
				            sf_b_beg_loc:sf_b.b_loc, sf_b_end_loc:sf_b.e_loc, sf_b_reset_fl:sf_b.reset_trigger, sf_b_enable_fl:sf_b.enable_fl,
					    
					    // sim_play_id:simul_mp.play_id,  sim_reset_fl:simul_mp.reset,   sim_clear_fl:simul_mp.clear,
					    // spr_play_id:spirio_mp.play_id,
					    spr_reset_fl:spirio_mp.reset,  spr_play_now:spirio_mp.play_excl_id,					    
					    },
				      args:{ cfg_fname:"~/src/currawong/projects/create_cult_event_score/gutim_pgm_ctl.json"},
				      ui: { create_fl:true }}


          // Defer starting the spirio segment by waiting for particular key/pedal releases
	  spirio_ctl: { class:gutim_spirio_ctl, in: { seg_id_in:ctl.spr_play_id,
	                                              reset:ctl.reset,
	                                              midi_in_a:m_in_a.r_out,
						      midi_in_b:m_in_b.r_out },						      
					        out: { seg_id_out:spirio_mp.play_id },						
	                                        args: { cfg_fname:"/home/kevin/src/currawong/projects/create_cult_event_score/gutim_spirio_ctl.json" }
						ui:   { create_fl:false } }


	 m_record: { class:midi_recorder, in:{ rin:sf.out, write_fl:ctl.reset }, args:{ dir:"~/temp/currawong/cult/mr_video/", fname:"record", alloc_cnt:102400 }}

         // spirio-multi-player to Spirio MIDI	- these message will be correctly velocity mapped even though they have not been score followed.
	 pian_vt_a:{ class: vel_table, in:{ in:extract_midi_a.out }, args:{ vel_tbl_fname:"$/vel_table_perf.json", vel_tbl_label:"spirio_1" }},
	 pian_vt_b:{ class: vel_table, in:{ in:extract_midi_b.out }, args:{ vel_tbl_fname:"$/vel_table_perf.json", vel_tbl_label:"spirio_1" }},
	 spirio_mout_a:   { class: midi_out,  in:{ rin:pian_vt_a.out }, args:{ print_fl:false, dev_label:"MIDIFACE 2x2", port_label:"MIDIFACE 2x2 Midi Out 1" } ui: { create_fl:false }} 
	 spirio_mout_b:   { class: midi_out,  in:{ rin:pian_vt_b.out }, args:{ print_fl:false, dev_label:"UM-ONE",  port_label:"UM-ONE MIDI 1" } ui: { create_fl:false }} 

         // messages coming from sf.out will have 'score_vel' fields assigned to them if they were located in the score
	 samp_vt:{ class: vel_table, in:{ in:sf.out }, args:{ vel_tbl_fname:"$/vel_table_perf.json", vel_tbl_label:"ivory" }},

         vctl:   { class: poly_voice_ctl,             in:{ in:samp_vt.out , reset:ctl.reset},  args:{ voice_cnt:40, prune_thresh:20 } },

	 ps:     { class: gutim_ps, preset:init,         in:{ in:sf.out, midi_in_:vctl.out_, reset:ctl.reset, loc_cnt:sf_a.loc_cnt   },
	                                             preset: "init",
	                                               args:{ fname:"~/src/currawong/projects/create_cult_event_score/cult_evt_xforms_mod.txt" },
						          ui:  { create_fl:true } },

	  xform_igain:  { class: number,   args:{ in:1.0f },  ui: { create_fl:true } },

	  voice_poly: {
	    class: poly,
	    in:   { count:vctl.voice_cnt },		  
	    args: { parallel_fl:false, thread_cnt:8, cpu_affinityL:[2,3,4,6,8,9,10,11] },

	    network: {
	      procs: {
	        voc: { class:piano_voice, in:{ _.in:_.vctl.out_ },
		                          out:{ _.done_fl:_.vctl.done_fl_ },
					  args:{ wtb_fname:"~/media/audio/wt6/wt_bank.json",
					         wtb_instr:"piano",
						 rls_coeff: 0.99 } },
						 
		g:     { class: audio_gain,       in:{ in:voc.out, gain:_.xform_igain.out }  },
	        pva:   { class: pv_analysis,      in:{ in:g.out, enable:voc.gate_fl, _.wndSmpN:_.ps.wnd_smp_cnt_ },  args:{ wndSmpN:512, hopSmpN:128, hzFl:false  } },
	        sd:    { class: spec_dist,        in:{ in:pva.out,
		                                       enable:voc.gate_fl,
		                                       _.ceiling:_.ps.ceiling_,
						       _.expo:_.ps.expo_,
						       _.thresh:_.ps.thresh_,
						       _.upr:_.ps.upr_,
						       _.lwr:_.ps.lwr_,
						       _.mix:_.ps.mix_ },  preset:kc, args:{ bypass:false }   },
		
                pvs:   { class: pv_synthesis,     in:{ in:sd.out, enable:voc.gate_fl  } },
	        cmp:   { class: compressor,       in:{ in:pvs.out,
		                                       enable:voc.gate_fl,
		                                       _.igain:_.ps.c_igain_,
						       _.ogain:_.ps.c_ogain_ }, preset:kc, args:{ bypass:false }   },
						       
		ogain: { class: audio_gain,       in:{ in:cmp.out, _.gain:_.ps.dry_gain_ } },
	      }

	    }
	  }


	  wet_poly_mix: { class: audio_mix,   in:{ in_:voice_poly.ogain_.out } args:{ igain_:1.0 }},
	  dry_poly_mix: { class: audio_mix,   in:{ in_:voice_poly.voc_.out}    args:{ igain_:1.0 }},


	  // apply the wet/dry gain balance
	  wd_bal:       { class: balance, args{}},
	  wet_bal_gain: { class: audio_gain, in:{ in:wet_poly_mix.out, gain:wd_bal.out }     },
	  dry_bal_gain: { class: audio_gain, in:{ in:dry_poly_mix.out, gain:wd_bal.inv_out } },

	  mstr_wet_out: { class: audio_gain, in:{ in:wet_bal_gain.out }, args:{ gain:0.5 } }
	  mstr_dry_out: { class: audio_gain, in:{ in:dry_bal_gain.out }, args:{ gain:0.5 } },
	   

	  // merge the wet/dry signals into a single 4 channel signal
	  merge: { class: audio_merge,   in:{ in0:mstr_wet_out.out, in1:mstr_dry_out.out }  },

	  sync_delay { class: audio_delay, in: { in:merge.out }, args:{ delayMs:400 }}

	  xfade { class: audio_xfade, in:{ in_a:merge.out, in_b:sync_delay.out,
	                                    reset:ctl.reset,
	                                    ab_trig:spirio_ctl.seg_id_out, ab_trig_alt:ctl.spr_play_now,
					    ba_trig:ctl.sim_play_id },
	                              args: { ab_ms:500, ba_ms:500 } }


          aout:  { class: audio_out,     in:{ in:xfade.out }, args:{ dev_label:"main" } },

				  
        }
      }
    } // ex_23_rt_audio

  } // programs
} // 